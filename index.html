<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyUniform | Pompano Beach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            overflow-x: hidden; 
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
        }

        /* ANIMATED MESH BACKGROUND */
        .mesh-bg {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: meshGradient 15s ease infinite;
        }

        @keyframes meshGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* MANNEQUIN BASE SETUP */
        .mannequin-container { 
            position: relative; 
            width: 480px; 
            height: 620px; 
            display: flex; 
            justify-content: center; 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .mannequin-img {
            height: 100%;
            width: auto;
            object-fit: contain;
            z-index: 10;
            filter: drop-shadow(0 20px 40px rgba(0,0,0,0.4));
        }

        /* --- AUTO-ALIGNING POSITION ENGINES --- */
        .ribbon-rack-container { 
            position: absolute; 
            top: 22.5%; 
            left: 69.5%;  
            transform: translateX(-50%); /* Removed translate-y because we want it to build downward from the top-alignment point */
            display: flex; 
            flex-direction: column; /* Changed from column-reverse to standard column */
            gap: 1.5px; 
            align-items: center; 
            z-index: 20;
            pointer-events: none;
        }

        .medals-container {
            position: absolute;
            top: 35.5%;
            left: 69.5%;
            transform: translateX(-50%);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 120px;
            gap: 2px;
            z-index: 20;
        }

        .arcs-container {
            position: absolute;
            top: 35.5%;
            left: 30.5%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 3px;
            align-items: center;
            z-index: 20;
        }

        /* --- THE IPHONE/IPAD FIX (SCALING ENGINE) --- */
        @media (max-width: 768px) {
            .mannequin-container { width: 380px; height: 520px; }
            .ribbon-rack-container { top: 21.5%; left: 69.8%; transform: translateX(-50%) scale(0.9); }
            .medals-container { top: 35.8%; left: 69.8%; transform: translateX(-50%) scale(0.9); }
            .arcs-container { top: 35.8%; left: 30.8%; transform: translateX(-50%) scale(0.9); }
        }

        @media (max-width: 480px) {
            .mannequin-container { width: 320px; height: 440px; }
            .ribbon-rack-container { top: 20%; left: 70.2%; transform: translateX(-50%) scale(0.85); }
            .medals-container { top: 36%; left: 70.2%; transform: translateX(-50%) scale(0.85); }
            .arcs-container { top: 36%; left: 30%; transform: translateX(-50%) scale(0.85); }
        }

        /* ITEM MINIATURES */
        .ribbon-mini, .medal-mini, .arc-mini {
            animation: itemPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes itemPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .ribbon-mini {
            width: 35px; height: 10px;
            background-size: 100% 100%;
            background-repeat: no-repeat;
            border: 0.4px solid rgba(0,0,0,0.9);
            position: relative;
            box-shadow: 0 0.5px 1px rgba(0,0,0,0.3);
        }

        .medal-mini {
            width: 20px; height: 32px;
            display: flex;
            flex-direction: column;
        }
        .medal-ribbon-part { width: 100%; height: 14px; border: 0.2px solid rgba(0,0,0,0.3); }
        .medal-coin-part { 
            width: 18px; height: 18px; 
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            border-radius: 50%; 
            margin: -2px auto 0;
            border: 0.5px solid rgba(0,0,0,0.4);
        }

        .arc-mini {
            padding: 1px 6px;
            background: #232d4b;
            color: #ffd700;
            border-radius: 4px;
            font-size: 7px;
            font-weight: 900;
            text-transform: uppercase;
            border: 0.5px solid #ffd700;
            white-space: nowrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .mini-star {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 7px; color: #ffd700;
            text-shadow: 0.5px 0.5px 1px black;
            width: 100%; text-align: center;
            letter-spacing: -1px;
            pointer-events: none;
        }

        /* UI ANIMATIONS */
        .list-item-anim {
            animation: listItemIn 0.4s cubic-bezier(0.22, 1, 0.36, 1) both;
        }

        @keyframes listItemIn {
            from { opacity: 0; transform: translateX(-15px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-tap:active { transform: scale(0.96); }
    </style>
</head>
<body>

    <!-- LANDING PAGE -->
    <div id="landing-page" class="mesh-bg fixed inset-0 z-50 flex flex-col items-center justify-center p-6 text-white transition-all duration-700">
        <div class="text-center fade-in-up">
            <h1 class="text-6xl font-black tracking-tighter mb-4">
                Broward <span class="text-indigo-400">JROTC</span>
            </h1>
            <p class="text-indigo-200/60 uppercase tracking-[0.3em] font-bold text-sm mb-12">Universal Uniform Builder</p>
        </div>
        
        <div onclick="enterApp()" class="fade-in-up group relative p-8 bg-white/5 backdrop-blur-xl rounded-[2.5rem] border border-white/10 hover:border-indigo-500/50 hover:bg-white/10 cursor-pointer transition-all w-full max-sm text-center" style="animation-delay: 0.2s">
            <div class="absolute inset-0 bg-indigo-500/20 blur-2xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <h3 class="font-bold text-2xl relative">Pompano Beach</h3>
            <p class="text-indigo-400 text-[11px] font-black uppercase tracking-widest mt-2 relative">Tornado Battalion</p>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="builder-content" class="hidden opacity-0 transition-opacity duration-500 min-h-screen">
        <header class="p-4 px-6 flex items-center justify-between sticky top-0 bg-white/70 backdrop-blur-2xl z-40 border-b border-slate-200/50">
            <button onclick="exitApp()" class="btn-tap bg-slate-100 hover:bg-slate-200 px-5 py-2.5 rounded-2xl font-bold text-xs uppercase tracking-tight transition-all">Back</button>
            <div class="text-center">
                <h2 class="text-lg font-black leading-tight">Pompano Beach HS</h2>
                <p class="text-indigo-600 font-black text-[9px] uppercase tracking-widest">Tornado Battalion</p>
            </div>
            <button onclick="resetAll()" class="btn-tap px-5 py-2.5 text-red-500 hover:bg-red-50 rounded-2xl font-bold text-xs uppercase tracking-wider transition-all">Reset</button>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-start">
            <!-- LEFT: VISUALIZER -->
            <div class="flex flex-col items-center lg:sticky lg:top-24">
                <div class="bg-slate-900 w-full rounded-[3.5rem] p-6 shadow-[0_32px_64px_-16px_rgba(0,0,0,0.3)] flex items-center justify-center overflow-hidden border-8 border-slate-800 relative">
                    <div class="mannequin-container" id="mannequin">
                        <img src="assets/Male_Class_A.png" class="mannequin-img" alt="Uniform" onerror="this.src='https://placehold.co/480x620/0f172a/6366f1?text=Class+A+Uniform'">
                        <div id="u-ribbons" class="ribbon-rack-container"></div>
                        <div id="u-medals" class="medals-container"></div>
                        <div id="u-arcs" class="arcs-container"></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: CONTROLS -->
            <div class="bg-white rounded-[3rem] p-8 shadow-2xl shadow-slate-200/50 border border-slate-100 h-[760px] flex flex-col">
                <div class="flex p-1.5 bg-slate-100/80 rounded-[2rem] mb-6">
                    <button id="btn-ribbons" onclick="setTab('ribbons')" class="flex-1 py-3.5 rounded-[1.7rem] font-bold text-sm bg-white text-indigo-600 shadow-sm transition-all">Ribbons</button>
                    <button id="btn-medals" onclick="setTab('medals')" class="flex-1 py-3.5 rounded-[1.7rem] font-bold text-sm text-slate-400 transition-all">Medals</button>
                    <button id="btn-arcs" onclick="setTab('arcs')" class="flex-1 py-3.5 rounded-[1.7rem] font-bold text-sm text-slate-400 transition-all">Arcs</button>
                </div>
                
                <div class="relative mb-6">
                    <input type="text" id="globalSearch" onkeyup="renderSelections()" placeholder="Search awards..." class="w-full p-4 pl-6 rounded-2xl border border-slate-200 bg-slate-50 text-sm outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all">
                </div>
                
                <div id="selection-list" class="space-y-3 overflow-y-auto pr-2 flex-1 scroll-smooth"></div>
            </div>
        </div>
    </div>

    <script>
        const OFFICIAL_RIBBONS = [
            { id: 'hero', name: 'Medal for Heroism', precedence: 1, img: 'assets/army_jrotc_medal_for_heroism_ribbon.png' },
            { id: 'sup-c', name: 'Superior Cadet Award', precedence: 2, img: 'assets/army_jrotc_superior_cadet_ribbon.png' },
            { id: 'n11', name: 'Distinguished Cadet Award N-1-1', precedence: 3, img: 'assets/army_jrotc_distinguished_cadet_ribbon.png' },
            { id: 'n12', name: 'Academic Excellence Award N-1-2', precedence: 4, img: 'assets/army_jrotc_academic_excellence_ribbon.png' },
            { id: 'n13', name: 'Academic Achievement Award N-1-3', precedence: 5, img: 'assets/army_jrotc_academic_achievement_ribbon.png' },
            { id: 'n14', name: 'Perfect Attendance Award N-1-4', precedence: 6, img: 'assets/army_jrotc_perfect_attendance_ribbon.png' },
            { id: 'n15', name: 'Student Governement Award N-1-5', precedence: 7, img: 'assets/army_jrotc_student_government_ribbon.png' },
            { id: 'n16', name: 'Leadership Education & Training N-1-6', precedence: 8, img: 'assets/army_jrotc_leadership_education_training_service_ribbon.png' },
            { id: 'n17', name: 'Superior Instructor N-1-7 Ribbon', precedence: 9, img: 'assets/army_jrotc_n_1_7_ribbon.png' },
            { id: 'n18', name: 'CPR First Aid N-1-8 Ribbon', precedence: 10, img: 'assets/army_jrotc_n_1_8_ribbon.png' },
            { id: 'n19', name: 'Distinguished Cadet N-1-9 Ribbon', precedence: 11, img: 'assets/army_jrotc_n_1_9_ribbon.png' },
            { id: 'n110', name: 'Honor Cadet N-1-10 Ribbon', precedence: 12, img: 'assets/army_jrotc_n_1_10_ribbon.png' },
            { id: 'n31', name: 'Dai/Sai Instructor Leadership N-3-1 Ribbon', precedence: 13, img: 'assets/army_jrotc_dai_sai_instructor_leadership_ribbon.png' },
            { id: 'n32', name: 'Personal Appearance N-3-2 Ribbon', precedence: 14, img: 'assets/army_jrotc_personal_appearance_ribbon.png' },
            { id: 'n33', name: 'Profiency N-3-3 Ribbon', precedence: 15, img: 'assets/army_jrotc_proficiency_ribbon.png' },
            { id: 'n34', name: 'Drill Team N-3-4 Ribbon', precedence: 16, img: 'assets/army_jrotc_drill_team_ribbon.png' },
            { id: 'n35', name: 'Orienteering N-3-5 Ribbon', precedence: 17, img: 'assets/army_jrotc_orienteering_ribbon.png' },
            { id: 'n36', name: 'Color | Honor Guard N-3-6 Ribbon', precedence: 18, img: 'assets/army_jrotc_color_guard_ribbon.png' },
            { id: 'n37', name: 'Rifle | Marksmanship Team N-3-7 Ribbon', precedence: 19, img: 'assets/army_jrotc_rifle_team_ribbon.png' },
            { id: 'n38', name: 'Adventure Training Team N-3-8 Ribbon', precedence: 20, img: 'assets/army_jrotc_adventure_training_ribbon.png' },
            { id: 'n39', name: 'Commendation N-3-9 Ribbon', precedence: 21, img: 'assets/army_jrotc_commendation_ribbon.png' },
            { id: 'n310', name: 'Good Conduct N-3-10 Ribbon', precedence: 22, img: 'assets/army_jrotc_good_conduct_ribbon.png' },
            { id: 'n311', name: 'JCLC Participation N-3-11 Ribbon', precedence: 23, img: 'assets/army_jrotc_jclc_participation_ribbon.png' },
            { id: 'n312', name: 'Championship Drill Team N-3-12 Ribbon', precedence: 24, img: 'assets/army_jrotc_n_3_12_ribbon.png' },
            { id: 'n313', name: 'Raider Team N-3-13 Ribbon', precedence: 25, img: 'assets/army_jrotc_n_3_13_ribbon.png' },
            { id: 'n314', name: 'Recondo / Rappelling N-3-14 Ribbon', precedence: 26, img: 'assets/army_jrotc_n_3_14_ribbon.png' },
            { id: 'n315', name: 'Meritorious Actions N-3-15 Ribbon', precedence: 27, img: 'assets/army_jrotc_n_3_15_ribbon.png' },
            { id: 'n21', name: 'Varsity Athletics Ribbon N-2-1', precedence: 28, img: 'assets/army_jrotc_varsity_athletics_ribbon.png' },
            { id: 'n22', name: 'Physical Fitness N-2-2 Ribbon', precedence: 29, img: 'assets/army_jrotc_physical_fitness_ribbon.png' },
            { id: 'n23', name: 'JROTC Athletics N-2-3 Ribbon', precedence: 30, img: 'assets/army_jrotc_athletics_ribbon.png' },
            { id: 'n24', name: 'Junior Varsity Athletics N-2-4 Ribbon', precedence: 31, img: 'assets/army_jrotc_n_2_4_ribbon.png' },
            { id: 'n25', name: 'Athletic Service N-2-5 Ribbon', precedence: 32, img: 'assets/army_jrotc_n_2_5_ribbon.png' },
            { id: 'n41', name: 'Parade N-4-1 Ribbon', precedence: 33, img: 'assets/army_jrotc_parade_ribbon.png' },
            { id: 'n42', name: 'Recruiting N-4-2 Ribbon', precedence: 34, img: 'assets/army_jrotc_recruiting_ribbon.png' },
            { id: 'n43', name: 'School Support N-4-3 Ribbon', precedence: 35, img: 'assets/army_jrotc_n_4_3_ribbon.png' },
            { id: 'n44', name: 'Community Service N-4-4 Ribbon', precedence: 36, img: 'assets/army_jrotc_n_4_4_ribbon.png' },
            { id: 'n45', name: 'Confidence Course N-4-5 Ribbon', precedence: 37, img: 'assets/army_jrotc_n_4_5_ribbon.png' },
            { id: 'n46', name: 'Service Learning N-4-6 Ribbon', precedence: 38, img: 'assets/army_jrotc_service_learning_ribbon.png' },
            { id: 'n47', name: 'Excellent Staff Performance N-4-7 Ribbon', precedence: 39, img: 'assets/army_jrotc_excellent_staff_performance_ribbon.png' }
        ];

        const POMPANO_RIBBONS = [
            { id: 'p1', name: 'Military Appreciation Ribbon', precedence: 200, img: 'assets/Military_Appreciation_Ribbon.png' },
            { id: 'p2', name: 'Q1 Cadet of the Quarter', precedence: 201, img: 'assets/Q1_Cadet_of_Quarter_Ribbion.png' },
            { id: 'p3', name: 'Q1 Company of the Quarter', precedence: 202, img: 'assets/Q1_Company_Of_Quarter_Ribbon.png' },
            { id: 'p4', name: 'Q2 Cadet of the Quarter', precedence: 203, img: 'assets/Q2_Cadet_Of_Quarter_Ribbon.png' },
            { id: 'p5', name: 'Q3 Cadet of the Quarter', precedence: 204, img: 'assets/Q3_Cadet_Of_Quarter_Ribbion.png' },
            { id: 'p6', name: 'Q4 Cadet of the Quarter', precedence: 205, img: 'assets/Q4_Cadet_Of_Quarter_Ribbion.png' },
            { id: 'p7', name: 'Q4 Company of the Quarter', precedence: 206, img: 'assets/Q4_Company_Of_Quarter.png' },
            { id: 'p8', name: 'Funeral Ribbon', precedence: 207, img: 'assets/Funeral_Ribbon.png' },
            { id: 'p9', name: 'Honor Company Ribbon', precedence: 208, img: 'assets/Honor_Company_Ribbon.png' },
            { id: 'p10', name: 'EC Attendance Ribbon', precedence: 209, img: 'assets/EC_Attendence_Ribbon.png' },
            { id: 'p11', name: 'EC Honor Cadet Ribbon', precedence: 210, img: 'assets/EC_Honor_Cadet_ribbion.png' },
            { id: 'p12', name: 'EC Honor Company Ribbon', precedence: 211, img: 'assets/EC_Honor_Company_Ribbon.png' },
            { id: 'p13', name: 'Company Req Completion Ribbon', precedence: 212, img: 'assets/Company_Req_Completion_Ribbon.png' }
        ];

        const MEDALS = [
            { id: 'm-hero', name: 'Heroism Medal', color: '#8b0000' },
            { id: 'm-sup', name: 'Superior Cadet Medal', color: '#1e3a8a' },
            { id: 'm-acad', name: 'Academic Achievement', color: '#fbbf24' },
            { id: 'm-cond', name: 'Good Conduct', color: '#16a34a' }
        ];

        const ARCS = [
            { id: 'a-drill', name: 'Drill Team' },
            { id: 'a-color', name: 'Color Guard' },
            { id: 'a-raider', name: 'Raider' },
            { id: 'a-rifle', name: 'Rifle Team' },
            { id: 'a-challenge', name: 'Cadet Challenge' },
            { id: 'a-jlab', name: 'JLAB' }
        ].sort((a,b) => a.name.localeCompare(b.name));

        let state = { ribbons: new Map(), medals: new Set(), arcs: new Set(), tab: 'ribbons' };

        // Persistence
        if(localStorage.getItem('myuniform_pompano_state')){
            const saved = JSON.parse(localStorage.getItem('myuniform_pompano_state'));
            state.ribbons = new Map(saved.ribbons);
            state.medals = new Set(saved.medals);
            state.arcs = new Set(saved.arcs);
        }

        function saveState(){
            localStorage.setItem('myuniform_pompano_state', JSON.stringify({
                ribbons: [...state.ribbons],
                medals: [...state.medals],
                arcs: [...state.arcs]
            }));
        }

        function enterApp() {
            const lp = document.getElementById('landing-page');
            const bc = document.getElementById('builder-content');
            lp.style.opacity = '0';
            lp.style.pointerEvents = 'none';
            setTimeout(() => {
                lp.classList.add('hidden');
                bc.classList.remove('hidden');
                setTimeout(() => bc.classList.add('opacity-100'), 50);
                renderSelections();
                updatePreview();
            }, 500);
        }

        function exitApp() { 
            document.getElementById('builder-content').classList.remove('opacity-100');
            setTimeout(() => location.reload(), 500);
        }

        function setTab(tab) {
            state.tab = tab;
            ['ribbons', 'medals', 'arcs'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                btn.className = (t === tab) 
                    ? "flex-1 py-3.5 rounded-[1.7rem] font-bold text-sm bg-white text-indigo-600 shadow-sm"
                    : "flex-1 py-3.5 rounded-[1.7rem] font-bold text-sm text-slate-400";
            });
            renderSelections();
        }

        function updateRibbon(id, d) {
            let count = (state.ribbons.get(id) || 0) + d;
            if (count <= 0) state.ribbons.delete(id); 
            else state.ribbons.set(id, Math.min(count, 5));
            triggerMannequinFeedback();
            updatePreview(); renderSelections(true); saveState();
        }

        function toggleItem(type, id) {
            state[type].has(id) ? state[type].delete(id) : state[type].add(id);
            triggerMannequinFeedback();
            updatePreview(); renderSelections(true); saveState();
        }

        function triggerMannequinFeedback() {
            const man = document.getElementById('mannequin');
            man.style.transform = 'scale(1.02)';
            setTimeout(() => man.style.transform = 'scale(1)', 150);
        }

        function renderSelections(skipAnim = false) {
            const list = document.getElementById('selection-list');
            const search = document.getElementById('globalSearch').value.toLowerCase();
            list.innerHTML = '';
            
            if (state.tab === 'ribbons') {
                const available = [...OFFICIAL_RIBBONS, ...POMPANO_RIBBONS]
                    .filter(r => r.name.toLowerCase().includes(search));
                
                available.forEach((r, i) => {
                    const count = state.ribbons.get(r.id) || 0;
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-4 rounded-2xl border transition-all ${count > 0 ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500/20' : 'bg-white border-slate-100'}`;
                    if(!skipAnim) {
                        div.classList.add('list-item-anim');
                        div.style.animationDelay = `${i * 0.03}s`;
                    }
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-14 h-4 border border-slate-200 bg-white flex items-center justify-center overflow-hidden shadow-inner">
                                <img src="${r.img}" class="w-full h-full object-fill" onerror="this.style.opacity='0'">
                            </div>
                            <span class="text-[11px] font-bold text-slate-700">${r.name}</span>
                        </div>
                        <div class="flex items-center bg-white rounded-xl border border-slate-200/50 p-1 shadow-sm">
                            <button onclick="updateRibbon('${r.id}', -1)" class="btn-tap w-8 h-8 font-bold text-slate-400 hover:text-red-500 transition-colors">-</button>
                            <span class="w-6 text-center text-xs font-black text-indigo-600">${count}</span>
                            <button onclick="updateRibbon('${r.id}', 1)" class="btn-tap w-8 h-8 text-indigo-600 font-bold hover:bg-indigo-50 rounded-lg transition-all">+</button>
                        </div>`;
                    list.appendChild(div);
                });
            } else if (state.tab === 'medals') {
                const available = MEDALS.filter(m => m.name.toLowerCase().includes(search));
                available.forEach((m, i) => {
                    const active = state.medals.has(m.id);
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${active ? 'border-indigo-500 bg-indigo-50' : 'bg-white border-slate-100'}`;
                    div.onclick = () => toggleItem('medals', m.id);
                    if(!skipAnim) {
                        div.classList.add('list-item-anim');
                        div.style.animationDelay = `${i * 0.03}s`;
                    }
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 rounded-full border border-slate-200" style="background:${m.color}"></div>
                            <span class="text-[11px] font-bold text-slate-700">${m.name}</span>
                        </div>
                        <span class="text-indigo-600 font-black">${active ? '✓' : '+'}</span>`;
                    list.appendChild(div);
                });
            } else {
                const available = ARCS.filter(a => a.name.toLowerCase().includes(search));
                available.forEach((a, i) => {
                    const active = state.arcs.has(a.id);
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${active ? 'border-indigo-500 bg-indigo-50' : 'bg-white border-slate-100'}`;
                    div.onclick = () => toggleItem('arcs', a.id);
                    if(!skipAnim) {
                        div.classList.add('list-item-anim');
                        div.style.animationDelay = `${i * 0.03}s`;
                    }
                    div.innerHTML = `<span class="text-[11px] font-bold text-slate-700">${a.name} Arc</span>
                                     <span class="text-indigo-600 font-black">${active ? '✓' : '+'}</span>`;
                    list.appendChild(div);
                });
            }
        }

        function updatePreview() {
            // RENDER RIBBONS
            const rContainer = document.getElementById('u-ribbons');
            rContainer.innerHTML = '';
            
            // 1. Get all active ribbons sorted by precedence (1 is highest)
            const activeR = [...OFFICIAL_RIBBONS, ...POMPANO_RIBBONS]
                .filter(r => state.ribbons.has(r.id))
                .sort((a,b) => a.precedence - b.precedence);

            // 2. Logic to build from TOP-LEFT:
            // Group into rows of 3 starting from the highest precedence (top)
            for(let i=0; i < activeR.length; i += 3) {
                const row = document.createElement('div');
                row.className = "flex gap-[1.5px]";
                
                activeR.slice(i, i+3).forEach(r => {
                    const d = document.createElement('div');
                    d.className = 'ribbon-mini';
                    d.style.backgroundImage = `url(${r.img})`;
                    const c = state.ribbons.get(r.id);
                    if(c > 1) {
                        const s = document.createElement('div');
                        s.className = 'mini-star';
                        s.innerText = '★'.repeat(c-1);
                        d.appendChild(s);
                    }
                    row.appendChild(d);
                });
                // Append rows so first group is at the top
                rContainer.appendChild(row);
            }

            // RENDER MEDALS
            const mContainer = document.getElementById('u-medals');
            mContainer.innerHTML = '';
            MEDALS.filter(m => state.medals.has(m.id)).forEach(m => {
                const d = document.createElement('div');
                d.className = 'medal-mini';
                d.innerHTML = `<div class="medal-ribbon-part" style="background:${m.color}"></div><div class="medal-coin-part"></div>`;
                mContainer.appendChild(d);
            });

            // RENDER ARCS
            const aContainer = document.getElementById('u-arcs');
            aContainer.innerHTML = '';
            ARCS.filter(a => state.arcs.has(a.id)).forEach(a => {
                const d = document.createElement('div');
                d.className = 'arc-mini';
                d.innerText = a.name;
                aContainer.appendChild(d);
            });
        }

        function resetAll() {
            const items = document.querySelectorAll('#selection-list > div');
            items.forEach((el, i) => {
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(20px)';
                }, i * 15);
            });
            
            setTimeout(() => {
                state.ribbons.clear();
                state.medals.clear();
                state.arcs.clear();
                if(document.getElementById('globalSearch')) document.getElementById('globalSearch').value = '';
                updatePreview();
                renderSelections();
                saveState();
            }, 300);
        }

        window.onload = () => {
            if (document.getElementById('builder-content').classList.contains('hidden') === false) {
                renderSelections();
                updatePreview();
            }
        };
    </script>
</body>
</html>
